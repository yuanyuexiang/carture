import { WechatUserInfo } from './wechat-auth';

interface VisitRecord {
  boutiqueId  /**
   * ä¿å­˜åˆ°localStorage
   */
  private saveToLocalStorage(): void {
    // åœ¨React Nativeç¯å¢ƒä¸­ç›´æ¥è¿”å›ï¼Œé¿å…è®¿é—®localStorage
    if (!this.isLocalStorageAvailable()) {
      console.log('ğŸ“š localStorageä¸å¯ç”¨ï¼ˆReact Nativeç¯å¢ƒï¼‰ï¼Œè·³è¿‡çŠ¶æ€ä¿å­˜');
      return;
    }

    try {
      const records = Array.from(this.recentRecords.values());
      window.localStorage!.setItem('visit_records_cache', JSON.stringify(records));
    } catch (error) {
      console.error('ä¿å­˜è®¿é—®è®°å½•ç¼“å­˜å¤±è´¥:', error);
    }
  }nId: string;
  timestamp: number;
  source: string;
}

/**
 * å…¨å±€è®¿é—®è®°å½•ç®¡ç†å™¨ - å•ä¾‹æ¨¡å¼
 * é˜²æ­¢é‡å¤è°ƒç”¨ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·-åº—é“ºç»„åˆåœ¨æŒ‡å®šæ—¶é—´å†…åªè®°å½•ä¸€æ¬¡è®¿é—®
 */
class VisitRecorderManager {
  private static instance: VisitRecorderManager | null = null;
  private pendingRecords: Map<string, Promise<any>> = new Map(); // æ­£åœ¨å¤„ç†çš„è®°å½•
  private recentRecords: Map<string, VisitRecord> = new Map(); // æœ€è¿‘çš„è®°å½•ç¼“å­˜
  private readonly DUPLICATE_INTERVAL = 30 * 60 * 1000; // 30åˆ†é’Ÿé˜²é‡å¤é—´éš”

  private constructor() {
    // ä»localStorageæ¢å¤çŠ¶æ€
    this.loadFromLocalStorage();
    
    // å®šæœŸæ¸…ç†è¿‡æœŸè®°å½•
    setInterval(() => this.cleanExpiredRecords(), 5 * 60 * 1000); // æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
  }

  public static getInstance(): VisitRecorderManager {
    if (!VisitRecorderManager.instance) {
      VisitRecorderManager.instance = new VisitRecorderManager();
    }
    return VisitRecorderManager.instance;
  }

  /**
   * ç”Ÿæˆè®°å½•é”®
   */
  private getRecordKey(openId: string, boutiqueId: string): string {
    return `${openId}:${boutiqueId}`;
  }

  /**
   * æ£€æŸ¥localStorageæ˜¯å¦å¯ç”¨
   */
  private isLocalStorageAvailable(): boolean {
    try {
      return typeof window !== 'undefined' && 
             typeof window.localStorage !== 'undefined' &&
             window.localStorage !== null;
    } catch (error) {
      return false;
    }
  }

  /**
   * ä»localStorageåŠ è½½çŠ¶æ€
   */
  private loadFromLocalStorage(): void {
    // åœ¨React Nativeç¯å¢ƒä¸­ç›´æ¥è¿”å›ï¼Œé¿å…è®¿é—®localStorage
    if (!this.isLocalStorageAvailable()) {
      console.log('ğŸ“š localStorageä¸å¯ç”¨ï¼ˆReact Nativeç¯å¢ƒï¼‰ï¼Œè·³è¿‡çŠ¶æ€åŠ è½½');
      return;
    }

    try {
      const savedRecords = window.localStorage!.getItem('visit_records_cache');
      if (savedRecords) {
        const records: VisitRecord[] = JSON.parse(savedRecords);
        const now = Date.now();
        
        // åªåŠ è½½æœªè¿‡æœŸçš„è®°å½•
        records.forEach(record => {
          if (now - record.timestamp < this.DUPLICATE_INTERVAL) {
            const key = this.getRecordKey(record.openId, record.boutiqueId);
            this.recentRecords.set(key, record);
          }
        });
        
        console.log('ğŸ“š åŠ è½½è®¿é—®è®°å½•ç¼“å­˜:', this.recentRecords.size, 'æ¡è®°å½•');
      }
    } catch (error) {
      console.error('åŠ è½½è®¿é—®è®°å½•ç¼“å­˜å¤±è´¥:', error);
    }
  }

  /**
   * ä¿å­˜åˆ°localStorage
   */
  private saveToLocalStorage(): void {
    try {
      // æ£€æŸ¥æ˜¯å¦åœ¨æ”¯æŒlocalStorageçš„ç¯å¢ƒä¸­
      if (!this.isLocalStorageAvailable()) {
        console.log('ğŸ“š localStorageä¸å¯ç”¨ï¼Œè·³è¿‡çŠ¶æ€ä¿å­˜');
        return;
      }

      const records = Array.from(this.recentRecords.values());
      window.localStorage.setItem('visit_records_cache', JSON.stringify(records));
    } catch (error) {
      console.error('ä¿å­˜è®¿é—®è®°å½•ç¼“å­˜å¤±è´¥:', error);
    }
  }

  /**
   * æ¸…ç†è¿‡æœŸè®°å½•
   */
  private cleanExpiredRecords(): void {
    const now = Date.now();
    let cleanedCount = 0;
    
    for (const [key, record] of this.recentRecords.entries()) {
      if (now - record.timestamp >= this.DUPLICATE_INTERVAL) {
        this.recentRecords.delete(key);
        cleanedCount++;
      }
    }
    
    if (cleanedCount > 0) {
      console.log(`ğŸ§¹ æ¸…ç†äº† ${cleanedCount} æ¡è¿‡æœŸè®¿é—®è®°å½•`);
      this.saveToLocalStorage();
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦å¯ä»¥è®°å½•è®¿é—®
   */
  private canRecord(openId: string, boutiqueId: string): { canRecord: boolean; reason?: string } {
    const key = this.getRecordKey(openId, boutiqueId);
    
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤„ç†ä¸­
    if (this.pendingRecords.has(key)) {
      return { canRecord: false, reason: 'æ­£åœ¨å¤„ç†ä¸­' };
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨é˜²é‡å¤æ—¶é—´é—´éš”å†…
    const recentRecord = this.recentRecords.get(key);
    if (recentRecord) {
      const timeSinceLastRecord = Date.now() - recentRecord.timestamp;
      if (timeSinceLastRecord < this.DUPLICATE_INTERVAL) {
        const remainingMinutes = Math.ceil((this.DUPLICATE_INTERVAL - timeSinceLastRecord) / (60 * 1000));
        return { canRecord: false, reason: `${remainingMinutes}åˆ†é’Ÿå†…å·²è®°å½•è¿‡` };
      }
    }

    return { canRecord: true };
  }

  /**
   * è®°å½•è®¿é—®ï¼ˆå¼‚æ­¥ï¼Œé˜²é‡å¤ï¼‰
   */
  public async recordVisit(
    userInfo: WechatUserInfo,
    boutiqueId: string,
    source: string = 'unknown',
    recordFunction: (userInfo: WechatUserInfo, boutiqueId: string) => Promise<any>
  ): Promise<{ success: boolean; message?: string; error?: any }> {
    if (!userInfo?.openid || !boutiqueId) {
      return { success: false, message: 'ç¼ºå°‘å¿…è¦å‚æ•°' };
    }

    const { canRecord, reason } = this.canRecord(userInfo.openid, boutiqueId);
    
    if (!canRecord) {
      console.log(`â­ï¸ è·³è¿‡è®¿é—®è®°å½• (${source}):`, reason);
      return { success: false, message: reason };
    }

    const key = this.getRecordKey(userInfo.openid, boutiqueId);
    
    console.log(`ğŸ¯ å¼€å§‹è®°å½•è®¿é—® (${source}):`, {
      openId: userInfo.openid,
      nickName: userInfo.nickname,
      boutiqueId,
      timestamp: new Date().toLocaleString()
    });

    // åˆ›å»ºæ‰§è¡ŒPromiseå¹¶ç«‹å³å­˜å‚¨ï¼Œé˜²æ­¢å¹¶å‘è°ƒç”¨
    const recordPromise = this.executeRecord(userInfo, boutiqueId, source, recordFunction);
    this.pendingRecords.set(key, recordPromise);

    try {
      const result = await recordPromise;
      
      // è®°å½•æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜
      if (result.success) {
        const record: VisitRecord = {
          boutiqueId,
          openId: userInfo.openid,
          timestamp: Date.now(),
          source
        };
        
        this.recentRecords.set(key, record);
        this.saveToLocalStorage();
        console.log(`âœ… è®¿é—®è®°å½•å®Œæˆ (${source})`);
      }
      
      return result;
    } finally {
      // æ¸…ç†pendingçŠ¶æ€
      this.pendingRecords.delete(key);
    }
  }

  /**
   * å®é™…æ‰§è¡Œè®°å½•
   */
  private async executeRecord(
    userInfo: WechatUserInfo,
    boutiqueId: string,
    source: string,
    recordFunction: (userInfo: WechatUserInfo, boutiqueId: string) => Promise<any>
  ): Promise<{ success: boolean; message?: string; error?: any }> {
    try {
      const result = await recordFunction(userInfo, boutiqueId);
      return result;
    } catch (error) {
      console.error(`âŒ è®¿é—®è®°å½•æ‰§è¡Œå¤±è´¥ (${source}):`, error);
      return { success: false, error };
    }
  }

  /**
   * è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
   */
  public getStats() {
    return {
      pendingCount: this.pendingRecords.size,
      recentCount: this.recentRecords.size,
      recentRecords: Array.from(this.recentRecords.values())
    };
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const visitRecorderManager = VisitRecorderManager.getInstance();