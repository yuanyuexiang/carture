import { useEffect, useRef } from 'react';
import { useViewManager } from './useViewManager';
import { WechatAuth, WechatUserInfo } from '../utils/wechat-auth';

export const useProductViewRecorder = (productId?: string) => {
  const { recordProductView } = useViewManager();
  const recordedRef = useRef<Set<string>>(new Set());
  
  console.log('ğŸš€ useProductViewRecorder Hook è°ƒç”¨ï¼ŒproductId:', productId, 'å·²è®°å½•å•†å“:', Array.from(recordedRef.current));

  const recordView = async (productId: string) => {
    try {
      if (!productId || recordedRef.current.has(productId)) {
        console.log('âš ï¸ å•†å“å·²è®°å½•æˆ–IDä¸ºç©ºï¼Œè·³è¿‡:', productId);
        return { success: false, message: 'å•†å“å·²è®°å½•æˆ–IDä¸ºç©º' };
      }

      console.log('ğŸ“ å¼€å§‹è®°å½•å•†å“æµè§ˆ:', productId);
      
      const wechatUser = WechatAuth.getUserInfo();
      if (wechatUser?.openid && wechatUser.openid !== 'test_openid_1757764361299') {
        console.log('âœ… ä½¿ç”¨çœŸå®å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯:', {
          openId: wechatUser.openid,
          nickName: wechatUser.nickname,
          type: 'wechat'
        });
        
        const result = await recordProductView({
          openId: wechatUser.openid,
          boutiqueId: '1', // ä»URLæˆ–å…¨å±€çŠ¶æ€è·å–
          productId: productId,
          nickName: wechatUser.nickname,
          avatar: wechatUser.headimgurl
        });
        
        recordedRef.current.add(productId);
        console.log('âœ… å¾®ä¿¡ç”¨æˆ·å•†å“æµè§ˆè®°å½•æˆåŠŸ:', productId);
        return { success: true, view: result };
      } else {
        console.log('âš ï¸ æœªè·å–åˆ°å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è¿‡æµè§ˆè®°å½•');
        return { success: false, message: 'éœ€è¦å¾®ä¿¡æˆæƒ' };
      }
    } catch (error) {
      console.error('âŒ è®°å½•å•†å“æµè§ˆå¤±è´¥:', error);
      return { success: false, error };
    }
  };

  useEffect(() => {
    console.log('ğŸ“± useEffect è§¦å‘ï¼ŒproductId:', productId);
    
    if (!productId || recordedRef.current.has(productId)) {
      console.log('âŒ å•†å“IDä¸ºç©ºæˆ–å·²è®°å½•ï¼Œè·³è¿‡');
      return;
    }
    
    console.log('â° è®¾ç½®å»¶è¿Ÿè®°å½•å•†å“æµè§ˆ');
    const timeoutId = setTimeout(() => {
      console.log('ğŸ¯ æ‰§è¡Œå»¶è¿Ÿå•†å“æµè§ˆè®°å½•');
      recordView(productId);
    }, 1000);

    return () => {
      console.log('ğŸ§¹ æ¸…ç†å»¶è¿Ÿè®°å½•å®šæ—¶å™¨');
      clearTimeout(timeoutId);
    };
  }, [productId]);

  return { recordView };
};
        avatar: currentUserInfo.headimgurl
      });

      if (result.success) {
        console.log('âœ… å•†å“æµè§ˆè®°å½•æˆåŠŸ:', result);
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶ï¼ˆä»…åœ¨ web ç¯å¢ƒä¸­ï¼‰
        if (typeof window !== 'undefined') {
          window.dispatchEvent(new CustomEvent('productViewRecorded', {
            detail: { productId, boutiqueId, userInfo: currentUserInfo, view: result.view }
          }));
        }
      }

      return result;
    } catch (error) {
      console.error('âŒ è®°å½•å•†å“æµè§ˆå¤±è´¥:', error);
      return { 
        success: false, 
        error, 
        message: `è®°å½•å•†å“æµè§ˆå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}` 
      };
    }
  };

  // è‡ªåŠ¨è®°å½•å½“å‰å•†å“æµè§ˆï¼ˆå¦‚æœæä¾›äº† productIdï¼‰
  useEffect(() => {
    console.log('ğŸ“± useEffect è§¦å‘ï¼ŒproductId:', productId);
    
    if (!productId) {
      console.log('âŒ æ²¡æœ‰ productIdï¼Œè·³è¿‡è‡ªåŠ¨è®°å½•');
      return;
    }

    const handleAutoRecord = async () => {
      console.log('ğŸ¯ å‡†å¤‡è‡ªåŠ¨è®°å½•å•†å“æµè§ˆï¼ŒproductId:', productId);
      
      // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
      setTimeout(async () => {
        console.log('â° å»¶è¿Ÿæ‰§è¡Œå•†å“æµè§ˆè®°å½•');
        const result = await recordView(productId);
        if (result.success) {
          console.log('ğŸ‰ è‡ªåŠ¨è®°å½•å•†å“æµè§ˆæˆåŠŸ');
        } else {
          console.log('âš ï¸ è‡ªåŠ¨è®°å½•å•†å“æµè§ˆå¤±è´¥:', result.message);
        }
      }, 1000);
    };

    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
    const existingUserInfo = WechatAuth.getUserInfo();
    if (existingUserInfo) {
      console.log('ï¿½ å‘ç°å·²æœ‰å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥è®°å½•å•†å“æµè§ˆ');
      handleAutoRecord();
    } else {
      console.log('ğŸ“± æœªå‘ç°å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼Œç›‘å¬æˆæƒæˆåŠŸäº‹ä»¶');
      
      // ç›‘å¬å¾®ä¿¡æˆæƒæˆåŠŸäº‹ä»¶
      if (typeof window !== 'undefined') {
        const handleWechatAuthSuccess = (event: CustomEvent<WechatUserInfo>) => {
          console.log('æ£€æµ‹åˆ°å¾®ä¿¡æˆæƒæˆåŠŸï¼Œå‡†å¤‡è®°å½•å•†å“æµè§ˆ');
          recordView(productId, event.detail);
        };

        window.addEventListener('wechatAuthSuccess', handleWechatAuthSuccess as EventListener);
        
        return () => {
          window.removeEventListener('wechatAuthSuccess', handleWechatAuthSuccess as EventListener);
        };
      } else {
        console.log('ğŸ“± React Native ç¯å¢ƒï¼Œæ— æ³•ç›‘å¬æˆæƒäº‹ä»¶');
      }
    }
  }, [productId]);

  // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œè®°å½•ç”¨æˆ·ç¦»å¼€é¡µé¢çš„æ—¶é—´ï¼ˆä»…åœ¨ web ç¯å¢ƒä¸­ï¼‰
  useEffect(() => {
    if (!productId || typeof window === 'undefined') return;

    let viewStartTime = Date.now();
    
    const handleVisibilityChange = () => {
      if (document.hidden) {
        // é¡µé¢å˜ä¸ºä¸å¯è§ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®°å½•æµè§ˆæ—¶é•¿ç­‰ä¿¡æ¯
        const viewDuration = Date.now() - viewStartTime;
        console.log(`å•†å“ ${productId} æµè§ˆæ—¶é•¿: ${Math.round(viewDuration / 1000)}ç§’`);
        
        // è§¦å‘æµè§ˆç»“æŸäº‹ä»¶
        window.dispatchEvent(new CustomEvent('productViewEnded', {
          detail: { productId, duration: viewDuration }
        }));
      } else {
        // é¡µé¢å˜ä¸ºå¯è§ï¼Œé‡ç½®è®¡æ—¶
        viewStartTime = Date.now();
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [productId]);

  return {
    recordView,
    // æä¾›ç»™ç»„ä»¶ä½¿ç”¨çš„ä¾¿æ·æ–¹æ³•
    recordCurrentView: () => productId ? recordView(productId) : Promise.resolve({ success: false, message: 'ç¼ºå°‘ productId' })
  };
};