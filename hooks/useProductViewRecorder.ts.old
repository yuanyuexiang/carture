import { useEffect, useRef } from 'react';
import { useViewManager } from './useViewManager';
import { WechatAuth, WechatUserInfo } from '../utils/wechat-auth';

export const useProductViewRecorder = (productId?: string) => {
  const { recordProductView } = useViewManager();
  const recordedRef = useRef<Set<string>>(new Set());
  
  console.log('🚀 useProductViewRecorder Hook 调用，productId:', productId, '已记录商品:', Array.from(recordedRef.current));

  const recordView = async (productId: string) => {
    try {
      if (!productId || recordedRef.current.has(productId)) {
        console.log('⚠️ 商品已记录或ID为空，跳过:', productId);
        return { success: false, message: '商品已记录或ID为空' };
      }

      console.log('📝 开始记录商品浏览:', productId);
      
      const wechatUser = WechatAuth.getUserInfo();
      if (wechatUser?.openid && wechatUser.openid !== 'test_openid_1757764361299') {
        console.log('✅ 使用真实微信用户信息:', {
          openId: wechatUser.openid,
          nickName: wechatUser.nickname,
          type: 'wechat'
        });
        
        const result = await recordProductView({
          openId: wechatUser.openid,
          boutiqueId: '1', // 从URL或全局状态获取
          productId: productId,
          nickName: wechatUser.nickname,
          avatar: wechatUser.headimgurl
        });
        
        recordedRef.current.add(productId);
        console.log('✅ 微信用户商品浏览记录成功:', productId);
        return { success: true, view: result };
      } else {
        console.log('⚠️ 未获取到微信用户信息，跳过浏览记录');
        return { success: false, message: '需要微信授权' };
      }
    } catch (error) {
      console.error('❌ 记录商品浏览失败:', error);
      return { success: false, error };
    }
  };

  useEffect(() => {
    console.log('📱 useEffect 触发，productId:', productId);
    
    if (!productId || recordedRef.current.has(productId)) {
      console.log('❌ 商品ID为空或已记录，跳过');
      return;
    }
    
    console.log('⏰ 设置延迟记录商品浏览');
    const timeoutId = setTimeout(() => {
      console.log('🎯 执行延迟商品浏览记录');
      recordView(productId);
    }, 1000);

    return () => {
      console.log('🧹 清理延迟记录定时器');
      clearTimeout(timeoutId);
    };
  }, [productId]);

  return { recordView };
};
        avatar: currentUserInfo.headimgurl
      });

      if (result.success) {
        console.log('✅ 商品浏览记录成功:', result);
        
        // 触发自定义事件，通知其他组件（仅在 web 环境中）
        if (typeof window !== 'undefined') {
          window.dispatchEvent(new CustomEvent('productViewRecorded', {
            detail: { productId, boutiqueId, userInfo: currentUserInfo, view: result.view }
          }));
        }
      }

      return result;
    } catch (error) {
      console.error('❌ 记录商品浏览失败:', error);
      return { 
        success: false, 
        error, 
        message: `记录商品浏览失败: ${error instanceof Error ? error.message : '未知错误'}` 
      };
    }
  };

  // 自动记录当前商品浏览（如果提供了 productId）
  useEffect(() => {
    console.log('📱 useEffect 触发，productId:', productId);
    
    if (!productId) {
      console.log('❌ 没有 productId，跳过自动记录');
      return;
    }

    const handleAutoRecord = async () => {
      console.log('🎯 准备自动记录商品浏览，productId:', productId);
      
      // 延迟一下，确保页面完全加载
      setTimeout(async () => {
        console.log('⏰ 延迟执行商品浏览记录');
        const result = await recordView(productId);
        if (result.success) {
          console.log('🎉 自动记录商品浏览成功');
        } else {
          console.log('⚠️ 自动记录商品浏览失败:', result.message);
        }
      }, 1000);
    };

    // 检查是否已经有微信用户信息
    const existingUserInfo = WechatAuth.getUserInfo();
    if (existingUserInfo) {
      console.log('� 发现已有微信用户信息，直接记录商品浏览');
      handleAutoRecord();
    } else {
      console.log('📱 未发现微信用户信息，监听授权成功事件');
      
      // 监听微信授权成功事件
      if (typeof window !== 'undefined') {
        const handleWechatAuthSuccess = (event: CustomEvent<WechatUserInfo>) => {
          console.log('检测到微信授权成功，准备记录商品浏览');
          recordView(productId, event.detail);
        };

        window.addEventListener('wechatAuthSuccess', handleWechatAuthSuccess as EventListener);
        
        return () => {
          window.removeEventListener('wechatAuthSuccess', handleWechatAuthSuccess as EventListener);
        };
      } else {
        console.log('📱 React Native 环境，无法监听授权事件');
      }
    }
  }, [productId]);

  // 监听页面可见性变化，记录用户离开页面的时间（仅在 web 环境中）
  useEffect(() => {
    if (!productId || typeof window === 'undefined') return;

    let viewStartTime = Date.now();
    
    const handleVisibilityChange = () => {
      if (document.hidden) {
        // 页面变为不可见，可以在这里记录浏览时长等信息
        const viewDuration = Date.now() - viewStartTime;
        console.log(`商品 ${productId} 浏览时长: ${Math.round(viewDuration / 1000)}秒`);
        
        // 触发浏览结束事件
        window.dispatchEvent(new CustomEvent('productViewEnded', {
          detail: { productId, duration: viewDuration }
        }));
      } else {
        // 页面变为可见，重置计时
        viewStartTime = Date.now();
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [productId]);

  return {
    recordView,
    // 提供给组件使用的便捷方法
    recordCurrentView: () => productId ? recordView(productId) : Promise.resolve({ success: false, message: '缺少 productId' })
  };
};